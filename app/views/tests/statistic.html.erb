<%
   total_count = 0
   true_count = 0
   false_count = 0
%>

<%= content_for :title, 'Статистика' %>
<div class="mainpanel">
  <div class="pageheader">
    <div class="row">
      <div class="col-sm-3 col-lg-2">
        <%= link_to @test, class:'btn btn-white back-btn pull-right', title: 'Назад'  do %>
          <i class="fa fa-arrow-left"></i>
        <% end %>

        <h3>Статистика</h3>
      </div>
      <div class="col-sm-9 col-lg-9">
        <div class="breadcrumb-wrapper">
          <ol class="breadcrumb">
            <li class="">
                  <%= link_to @test.title, @test %>
            </li>
          </ol>
        </div>
      </div>
    </div>
  </div>
  <div class="contentpanel ">
    <div class="row">
      <div class="col-lg-12">
        <div class="panel panel-default">
          <div class="panel-body panel-profile">


            <% @test.tries.each do |try| %>
                <% try.task_results.each do |tr|%>
                    <%
                       total_count = total_count + 1
                       if tr.status == 'правильно'
                         true_count = true_count + 1
                       elsif tr.status == 'не правильно'
                         false_count = false_count + 1
                       end
                    %>
                <% end%>
            <% end %>

            <!-- Открытие контейнера -->
            <div class="container-fluid">

              <!-- Начало блока с названием теста -->
              <div class="row">
                <div class="col-lg-12">
                  <hr>
                    <h4 class="text-center">Общая статистика</h4>
                  <hr>
                </div>
              </div>
              <!-- Конец блока с названием теста -->

              <!-- Начало блока с общей информацией о тесте -->
              <div class="row">
                <div class="col-lg-12">
                  <table class="table table-bordered">
                    <tr>
                      <th class="cell-header-bgcolor info">Кол-во заданий в тесте:</th>
                      <th class="cell-header-bgcolor info">Кол-во попыток:</th>
                      <th class="cell-header-bgcolor info">Средняя оценка за тест:</th>
                      <th class="cell-header-bgcolor info">Среднее время, потраченное на тест:</th>
                    </tr>
                    <tr>
                      <td><%= @test.tasks.count %></td>
                      <td><%= @test.tries.count %></td>
                      <td><%= @test.tries.where(:status => 'Выполнен').any? ? (@test.tries.inject(0) { |sum, hash| sum + hash[:rate] })/@test.tries.count : 'N/A' %></td>
                      <td><%= (@hours && @minutes).nil? ? 'N/A' : (@hours.to_s + ' часов ' + @minutes.to_s + ' минут') %></td>
                    </tr>
                  </table>
                </div>
              </div>
              <!-- Конец блока с общей информацией о тесте -->

              <!-- Начало блока с заголовком -->
              <div class="row">
                <div class="col-lg-12">
                  <hr>
                  <h4 class="text-center">Статистика заданий</h4>
                </div>
              </div>
              <!-- Конец блока с заголовком -->
              <div class="mb10">
              <span class="btn btn-white btn-sm" onclick="$('.answers').show()">Развернуть</span>
              <span class="btn btn-white btn-sm" onclick="$('.answers').hide()">Свернуть</span>
              </div>
              <table class="table table-bordered">
                <tbody>
                  <% @test.tasks.each do |task| %>
                    <% result_count = task.task_results.count %>
                    <tr>
                      <td style="padding: 0 8px; vertical-align: middle; width: 40px; font-size: 25px; cursor: pointer" class="task-type-icon">
                        <%= task_type_icon_class(task, 'div') %>
                      </td>
                      <td>
                        <strong><%=strip_tags(task.text.squish) %></strong>
                      </td>
                      <td title="Верно" style="width: 120px" class="tooltips">
                        <% if result_count > 0 %>
                            <div class="progress statistic">
                              <% percent = task.task_results.where(status:'правильно').count * 100 / result_count %>
                              <div class="progress-bar progress-bar-success" style="min-width: 2em; width: <%= percent %>%;"><%= percent %>%</div>
                            </div>
                        <% end %>
                      </td>
                      <!--<td title="Частично верно" style="width: 120px" class="tooltips">-->
                        <!--<div class="progress statistic">-->
                          <!--<div class="progress-bar progress-bar-warning" style="min-width: 2em; width: 30%;">30%</div>-->
                        <!--</div>-->
                      <!--</td>-->
                      <td title="Не верно" style="width: 120px" class="tooltips">
                        <% if result_count > 0 %>
                        <div class="progress statistic">
                          <% percent = task.task_results.where(status:'не правильно').count * 100 / result_count %>
                          <div class="progress-bar progress-bar-danger" style="min-width: 2em; width: <%= percent %>%;"><%= percent %>%</div>
                        </div>
                        <% end %>
                      </td>
                    </tr>
                    <tr style="display: none" class="answers">
                      <td style="width: 30px"></td>
                      <td colspan="3"  style="background-color: #ffffff">
                        <table class="table" style="margin-bottom: 5px">
                          <tbody>
                          <%# all_answers = task.user_answers.count %>
                          <% task.answers.each do |answer| %>
                              <tr>
                                <td style="background-color:<%= answer.correct? ? '#006900' : 'white'  %> ; width: 5px; padding: 0"></td>
                                <td><%= answer.text %></td>
                                <!--<td style="width: 180px">-->
                                  <%# if all_answers > 0 %>
                                    <!--<div class="progress statistic">-->
                                      <%# percent = (answer.user_answers.count * 100) / all_answers  %>
                                      <!--<div class="progress-bar" style="width: <%#= percent %>%;"><%#= percent %></div>-->
                                    <!--</div>-->
                                  <%# end %>
                                <!--</td>-->
                              </tr>
                          <% end %>
                          </tbody>
                        </table>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
              <% @test.tasks.each do |task| %>
                  <!-- Начало блока со статистикой -->
                  <div class="row">
                    <!-- Начало блока с информацией о вопросе -->
                    <div class="col-lg-7">
                      <div class="row">
                        <div class="col-lg-12">
                          <table class="table table-bordered">
                            <tr>
                              <td colspan="3" class="cell-header-bgcolor info">
                                <p><b>Номер задания и его формулировка:</b></p>
                              </td>
                            </tr>
                            <tr>
                              <td colspan="3" class="cell-header-padding">
                                <p><%=strip_tags(task.text.squish) %></p>
                              </td>
                            </tr>
                            <tr>
                              <th class="cell-header-bgcolor info">
                                <p>Количество ответов:</p>
                              </th>
                              <th class="cell-header-bgcolor info">
                                <p>Правильный вариант ответа:</p>
                              </th>
                              <th class="cell-header-bgcolor info">
                                <p>Соотношение правильных и неправильных ответов:</p>
                              </th>

                            </tr>
                            <tr>
                              <td>
                                <p>
                                  <%

                                     count = 0
                                     @test.tries.each do |try|
                                       try.task_results.each do |task_result|
                                         if task_result.task_id == task.id
                                           count = count + 1
                                         end
                                       end
                                     end
                                  %>
                                  <%= count %>
                                </p>
                              </td>
                              <td class="success">
                                <p>
                                  <% task.answers.where(:correct => true).each do |answer|%>
                                      <%= answer.text %>
                                  <% end%>
                                </p>
                              </td>
                              <td>
                                <center>
                                  <span class="sparklines"><%= task.task_results.where(status: 'правильно').count%>,<%= task.task_results.where(status: 'не правильно').count%></span>
                                </center>
                              </td>

                            </tr>
                          </table>
                        </div>
                      </div>
                    </div>
                    <!-- Конец блока с информацией о вопросе -->

                    <!-- Начало блока с информацией об ответе -->
                    <div class="col-lg-5">
                      <table class="table table-bordered">
                        <tr>
                          <th class="cell-header-bgcolor info">
                            <p>Варианты ответа:</p>
                          </th>
                        </tr>
                        <% task.answers.each do |answer| %>
                            <tr>
                              <td width=80%>
                                <p><%= answer.text %></p>
                              </td>
                            </tr>
                        <% end %>
                      </table>
                    </div>
                    <!-- Конец блока с информацией об ответе -->
                  </div>
              <% end %>
              <!-- Конец блока со статистикой -->

              <!-- Начало блока с разделителем вопросов -->
              <div class="row">
                <div class="col-lg-12">
                  <hr>
                </div>
              </div>
              <!-- Конец блока с разделителем вопросов -->

            </div>
            <!-- Закрытие контейнера -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
